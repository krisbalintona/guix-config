#!/usr/bin/env bash
# Find video files by codec
# Dependencies: fd, ffprobe

set -euo pipefail

# Colors for output
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly NC='\033[0m' # No Color

# Configuration
dir="."
fd_opts=()
codec=""
verbose=false

# Parse arguments
script_args=()
while [[ $# -gt 0 ]]; do
    case $1 in
        -v|--verbose)
            verbose=true
            shift
            ;;
        -h|--help)
            echo "Usage: $0 CODEC [FD_OPTIONS] [DIRECTORY]"
            echo ""
            echo "Find all video files using a specific codec"
            echo ""
            echo "Arguments:"
            echo "  CODEC             Video codec to search for (e.g., hevc, h264, vp9)"
            echo ""
            echo "Script Options:"
            echo "  -v, --verbose     Show verbose output"
            echo "  -h, --help        Show this help message"
            echo ""
            echo "All other options are passed to fd (e.g., -E PATH to exclude)"
            echo "Last non-option argument is treated as directory (default: .)"
            echo ""
            echo "Examples:"
            echo "  $0 hevc                    # Find all hevc files in current directory"
            echo "  $0 h264 ~/Videos           # Find all h264 files in ~/Videos"
            echo "  $0 vp9 -E old ~/Videos     # Find vp9 files, excluding 'old' directory"
            exit 0
            ;;
        *)
            script_args+=("$1")
            shift
            ;;
    esac
done

# First argument must be the codec
if [ "${#script_args[@]}" -eq 0 ]; then
    echo -e "${RED}Error: Codec name required${NC}" >&2
    echo "Usage: $0 CODEC [FD_OPTIONS] [DIRECTORY]" >&2
    echo "Try '$0 --help' for more information." >&2
    exit 1
fi

codec="${script_args[0]}"
script_args=("${script_args[@]:1}")

# Parse remaining args for fd options and directory
if [ "${#script_args[@]}" -gt 0 ]; then
    last_arg="${script_args[-1]}"
    if [[ "$last_arg" != -* ]]; then
        dir="$last_arg"
        # All but the last arg go to fd_opts
        if [ "${#script_args[@]}" -gt 1 ]; then
            fd_opts=("${script_args[@]:0:${#script_args[@]}-1}")
        fi
    else
        # All args go to fd_opts
        fd_opts=("${script_args[@]}")
    fi
fi

# Verify dependencies
for cmd in fd ffprobe; do
    if ! command -v "$cmd" &> /dev/null; then
        echo -e "${RED}Error: Required command '$cmd' not found${NC}" >&2
        exit 1
    fi
done

echo -e "${GREEN}Searching for files with codec: ${YELLOW}$codec${NC}" >&2
echo -e "${GREEN}Directory: $dir${NC}" >&2
if [ "${#fd_opts[@]}" -gt 0 ]; then
    echo -e "${YELLOW}fd options: ${fd_opts[*]}${NC}" >&2
fi

# Count total files
total_files=$(fd -e mkv -e mp4 -e avi -e webm -e mov -e flv -e wmv -e m4v . \
                 --search-path "$dir" \
                 "${fd_opts[@]}" | wc -l)
echo -e "${YELLOW}Scanning $total_files files...${NC}" >&2

# Create temp file for results
temp_file=$(mktemp)
trap 'rm -f "$temp_file"' EXIT

# Find files with matching codec
fd -e mkv -e mp4 -e avi -e webm -e mov -e flv -e wmv -e m4v . \
   --search-path "$dir" \
   "${fd_opts[@]}" \
   -j 8 \
   -x bash -c '
       target_codec="$2"
       verbose="$3"
       
       codec=$(ffprobe -v error \
                       -read_intervals %+#1 \
                       -select_streams v:0 \
                       -show_entries stream=codec_name \
                       -of csv=p=0 \
                       "$1" 2>&1)
       
       if [ $? -eq 0 ] && [ "$codec" = "$target_codec" ]; then
           echo "$1"
       elif [ "$verbose" = "true" ] && [ $? -ne 0 ]; then
           echo "Warning: Could not read video stream from $1" >&2
       fi
   ' _ {} "$codec" "$verbose" > "$temp_file"

# Display results
count=$(wc -l < "$temp_file")

if [ "$count" -gt 0 ]; then
    echo -e "\n${GREEN}Found $count files with codec '$codec':${NC}"
    cat "$temp_file"
else
    echo -e "\n${RED}No files found with codec '$codec'${NC}" >&2
    exit 1
fi
