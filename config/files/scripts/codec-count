#!/usr/bin/env bash

# Count video files by codec and resolution
# Dependencies: fd, ffprobe, awk

set -euo pipefail

# Colors for output
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly NC='\033[0m' # No Color

# Configuration
dir="."
fd_opts=()
verbose=false

# Parse arguments - separate our flags from fd flags
script_args=()
while [[ $# -gt 0 ]]; do
    case $1 in
        -v|--verbose)
            verbose=true
            shift
            ;;
        -h|--help)
            echo "Usage: $0 [SCRIPT_OPTIONS] [FD_OPTIONS] [DIRECTORY]"
            echo ""
            echo "Script Options:"
            echo "  -v, --verbose     Show verbose output including errors"
            echo "  -h, --help        Show this help message"
            echo ""
            echo "All other options are passed to fd (e.g., -E PATH to exclude)"
            echo "Last non-option argument is treated as directory (default: .)"
            exit 0
            ;;
        *)
            script_args+=("$1")
            shift
            ;;
    esac
done

# Now parse the remaining args for fd options and directory
if [ "${#script_args[@]}" -gt 0 ]; then
    last_arg="${script_args[-1]}"
    if [[ "$last_arg" != -* ]]; then
        dir="$last_arg"
        # All but the last arg go to fd_opts
        if [ "${#script_args[@]}" -gt 1 ]; then
            fd_opts=("${script_args[@]:0:${#script_args[@]}-1}")
        fi
    else
        # All args go to fd_opts
        fd_opts=("${script_args[@]}")
    fi
fi

# Verify dependencies
for cmd in fd ffprobe awk sort uniq; do
    if ! command -v "$cmd" &> /dev/null; then
        echo -e "${RED}Error: Required command '$cmd' not found${NC}" >&2
        exit 1
    fi
done

# Create temporary file for results
temp_file=$(mktemp)
trap 'rm -f "$temp_file"' EXIT

echo -e "${GREEN}Scanning video files in: $dir${NC}" >&2
if [ "${#fd_opts[@]}" -gt 0 ]; then
    echo -e "${YELLOW}fd options: ${fd_opts[*]}${NC}" >&2
fi

# Count files
total_files=$(fd -e mkv -e mp4 -e avi -e webm -e mov -e flv -e wmv -e m4v . \
                 --search-path "$dir" \
                 "${fd_opts[@]}" | wc -l)
echo -e "${YELLOW}Found $total_files files to analyze${NC}" >&2

# Process files
fd -e mkv -e mp4 -e avi -e webm -e mov -e flv -e wmv -e m4v . \
   --search-path "$dir" \
   "${fd_opts[@]}" \
   -j 8 \
   -x bash -c '
       output=$(ffprobe -v error \
                        -read_intervals %+#1 \
                        -select_streams v:0 \
                        -show_entries stream=codec_name,width,height \
                        -of csv=p=0 \
                        "$1" 2>&1)
       
       if [ $? -eq 0 ] && [ -n "$output" ]; then
           echo "$output"
       elif [ "$2" = "true" ]; then
           echo "Warning: Could not read video stream from $1" >&2
       fi
   ' _ {} "$verbose" \
    | awk -F, '
   {
     c=$1; w=$2; h=$3;
     
     # Skip invalid entries
     if (c == "" || w == "" || h == "") next;
     
     # Determine resolution category
     if (w >= 3800 || h >= 2100) r="4K";
     else if (w >= 2500 || h >= 1400) r="2K";
     else if (w >= 1900 || h >= 1000) r="1080p";
     else if (w >= 1200 || h >= 700) r="720p";
     else if (w >= 600 || h >= 400) r="480p";
     else r="SD";
     
     print c "," r
   }' \
    | sort | uniq -c | sort -nr > "$temp_file"

# Display results
if [ -s "$temp_file" ]; then
    echo -e "\n${GREEN}Results:${NC}"
    echo -e "${YELLOW}Count  Codec        Resolution${NC}"
    echo "=============================="
    awk '{printf "%-6s %-12s %s\n", $1, $2, $3}' FS=',' "$temp_file"
    
    # Summary
    total=$(awk '{sum+=$1} END {print sum}' "$temp_file")
    echo "=============================="
    echo -e "Total files analyzed: ${GREEN}$total${NC}"
else
    echo -e "${RED}No video files found${NC}" >&2
    exit 1
fi
